const { SlashCommandBuilder, PermissionFlagsBits, EmbedBuilder, MessageFlags } = require('discord.js');
const fs = require('fs');
const path = require('path');

// Arquivo para armazenar as advert√™ncias
const WARN_FILE = path.join(__dirname, '..', 'data', 'warnings.json');

// Garantir que o diret√≥rio data existe
if (!fs.existsSync(path.dirname(WARN_FILE))) {
    fs.mkdirSync(path.dirname(WARN_FILE), { recursive: true });
}

// Carregar advert√™ncias do arquivo
function loadWarnings() {
    try {
        if (fs.existsSync(WARN_FILE)) {
            return JSON.parse(fs.readFileSync(WARN_FILE, 'utf8'));
        }
    } catch (error) {
        console.error('Erro ao carregar advert√™ncias:', error);
    }
    return {};
}

// Salvar advert√™ncias no arquivo
function saveWarnings(warnings) {
    try {
        fs.writeFileSync(WARN_FILE, JSON.stringify(warnings, null, 4));
        return true;
    } catch (error) {
        console.error('Erro ao salvar advert√™ncias:', error);
        return false;
    }
}

// Adicionar advert√™ncia
function addWarning(guildId, userId, reason, moderatorId) {
    const warnings = loadWarnings();
    
    if (!warnings[guildId]) {
        warnings[guildId] = {};
    }
    
    if (!warnings[guildId][userId]) {
        warnings[guildId][userId] = [];
    }
    
    const warning = {
        id: Date.now(),
        reason: reason || 'Sem motivo especificado',
        moderator: moderatorId,
        date: new Date().toISOString(),
        timestamp: Date.now()
    };
    
    warnings[guildId][userId].push(warning);
    
    return saveWarnings(warnings) ? warning : null;
}

// Obter advert√™ncias de um usu√°rio
function getUserWarnings(guildId, userId) {
    const warnings = loadWarnings();
    return warnings[guildId]?.[userId] || [];
}

// Remover advert√™ncia espec√≠fica
function removeWarning(guildId, userId, warningId) {
    const warnings = loadWarnings();
    
    if (warnings[guildId]?.[userId]) {
        warnings[guildId][userId] = warnings[guildId][userId].filter(w => w.id !== warningId);
        return saveWarnings(warnings);
    }
    
    return false;
}

// Limpar todas as advert√™ncias de um usu√°rio
function clearUserWarnings(guildId, userId) {
    const warnings = loadWarnings();
    
    if (warnings[guildId]?.[userId]) {
        delete warnings[guildId][userId];
        return saveWarnings(warnings);
    }
    
    return false;
}

module.exports = {
    data: new SlashCommandBuilder()
        .setName('warn')
        .setDescription('Sistema de advert√™ncias')
        .setDefaultMemberPermissions(PermissionFlagsBits.ModerateMembers)
        .addSubcommand(subcommand =>
            subcommand
                .setName('add')
                .setDescription('Advertir um usu√°rio')
                .addUserOption(option =>
                    option.setName('usu√°rio')
                        .setDescription('Usu√°rio a ser advertido')
                        .setRequired(true)
                )
                .addStringOption(option =>
                    option.setName('motivo')
                        .setDescription('Motivo da advert√™ncia')
                        .setRequired(false)
                )
        )
        .addSubcommand(subcommand =>
            subcommand
                .setName('list')
                .setDescription('Listar advert√™ncias de um usu√°rio')
                .addUserOption(option =>
                    option.setName('usu√°rio')
                        .setDescription('Usu√°rio para ver as advert√™ncias')
                        .setRequired(true)
                )
        )
        .addSubcommand(subcommand =>
            subcommand
                .setName('remove')
                .setDescription('Remover uma advert√™ncia espec√≠fica')
                .addUserOption(option =>
                    option.setName('usu√°rio')
                        .setDescription('Usu√°rio para remover advert√™ncia')
                        .setRequired(true)
                )
                .addIntegerOption(option =>
                    option.setName('id')
                        .setDescription('ID da advert√™ncia a ser removida')
                        .setRequired(true)
                )
        )
        .addSubcommand(subcommand =>
            subcommand
                .setName('clear')
                .setDescription('Limpar todas as advert√™ncias de um usu√°rio')
                .addUserOption(option =>
                    option.setName('usu√°rio')
                        .setDescription('Usu√°rio para limpar advert√™ncias')
                        .setRequired(true)
                )
        ),

    async execute(interaction) {
        const subcommand = interaction.options.getSubcommand();
        const user = interaction.options.getUser('usu√°rio');
        const member = interaction.guild.members.cache.get(user.id);

        // Verificar se o usu√°rio existe no servidor
        if (!member) {
            return await interaction.reply({
                content: '‚ùå Usu√°rio n√£o encontrado neste servidor.',
                flags: MessageFlags.Ephemeral
            });
        }

        // Verificar se n√£o est√° tentando se auto-advertir
        if (user.id === interaction.user.id) {
            return await interaction.reply({
                content: '‚ùå Voc√™ n√£o pode se auto-advertir.',
                flags: MessageFlags.Ephemeral
            });
        }

        // Verificar hierarquia (n√£o pode advertir algu√©m com cargo igual ou superior)
        if (member.roles.highest.position >= interaction.member.roles.highest.position) {
            return await interaction.reply({
                content: '‚ùå Voc√™ n√£o pode advertir algu√©m com cargo igual ou superior ao seu.',
                flags: MessageFlags.Ephemeral
            });
        }

        try {
            switch (subcommand) {
                case 'add': {
                    const reason = interaction.options.getString('motivo') || 'Sem motivo especificado';
                    
                    // Adicionar advert√™ncia
                    const warning = addWarning(
                        interaction.guild.id,
                        user.id,
                        reason,
                        interaction.user.id
                    );

                    if (!warning) {
                        return await interaction.reply({
                            content: '‚ùå Erro ao salvar advert√™ncia.',
                            flags: MessageFlags.Ephemeral
                        });
                    }

                    // Embed de confirma√ß√£o
                    const warnEmbed = new EmbedBuilder()
                        .setColor(0xFFA500) // Laranja
                        .setTitle('‚ö†Ô∏è Advert√™ncia Aplicada')
                        .setDescription(`Usu√°rio: ${user.tag} (${user.id})`)
                        .addFields(
                            { name: 'Motivo', value: reason, inline: false },
                            { name: 'Moderador', value: interaction.user.tag, inline: true },
                            { name: 'ID da Advert√™ncia', value: warning.id.toString(), inline: true },
                            { name: 'Total de Advert√™ncias', value: getUserWarnings(interaction.guild.id, user.id).length.toString(), inline: true }
                        )
                        .setTimestamp()
                        .setFooter({ text: `Sistema de Advert√™ncias ‚Ä¢ ${interaction.guild.name}` });

                    await interaction.reply({ embeds: [warnEmbed] });

                    // Tentar enviar DM para o usu√°rio advertido
                    try {
                        const dmEmbed = new EmbedBuilder()
                            .setColor(0xFFA500)
                            .setTitle('‚ö†Ô∏è Voc√™ recebeu uma advert√™ncia')
                            .setDescription(`Servidor: **${interaction.guild.name}**`)
                            .addFields(
                                { name: 'Motivo', value: reason, inline: false },
                                { name: 'Moderador', value: interaction.user.tag, inline: true },
                                { name: 'ID da Advert√™ncia', value: warning.id.toString(), inline: true }
                            )
                            .setTimestamp();

                        await user.send({ embeds: [dmEmbed] });
                    } catch (dmError) {
                        console.log(`N√£o foi poss√≠vel enviar DM para ${user.tag}`);
                    }
                    break;
                }

                case 'list': {
                    const warnings = getUserWarnings(interaction.guild.id, user.id);
                    
                    if (warnings.length === 0) {
                        return await interaction.reply({
                            content: `‚úÖ ${user.tag} n√£o possui advert√™ncias.`,
                            flags: MessageFlags.Ephemeral
                        });
                    }

                    const embed = new EmbedBuilder()
                        .setColor(0x0099FF)
                        .setTitle(`üìã Advert√™ncias de ${user.tag}`)
                        .setDescription(`Total: **${warnings.length}** advert√™ncia(s)`)
                        .setThumbnail(user.displayAvatarURL());

                    warnings.forEach((warn, index) => {
                        embed.addFields({
                            name: `‚ö†Ô∏è Advert√™ncia #${index + 1} (ID: ${warn.id})`,
                            value: `**Motivo:** ${warn.reason}\n**Data:** <t:${Math.floor(new Date(warn.date).getTime() / 1000)}:F>\n**Moderador:** <@${warn.moderator}>`,
                            inline: false
                        });
                    });

                    await interaction.reply({ embeds: [embed], flags: MessageFlags.Ephemeral });
                    break;
                }

                case 'remove': {
                    const warningId = interaction.options.getInteger('id');
                    const warnings = getUserWarnings(interaction.guild.id, user.id);
                    const warningToRemove = warnings.find(w => w.id === warningId);

                    if (!warningToRemove) {
                        return await interaction.reply({
                            content: '‚ùå Advert√™ncia n√£o encontrada para este usu√°rio.',
                            flags: MessageFlags.Ephemeral
                        });
                    }

                    if (removeWarning(interaction.guild.id, user.id, warningId)) {
                        await interaction.reply({
                            content: `‚úÖ Advert√™ncia #${warningId} removida de ${user.tag}.`,
                            flags: MessageFlags.Ephemeral
                        });
                    } else {
                        await interaction.reply({
                            content: '‚ùå Erro ao remover advert√™ncia.',
                            flags: MessageFlags.Ephemeral
                        });
                    }
                    break;
                }

                case 'clear': {
                    const warningsCount = getUserWarnings(interaction.guild.id, user.id).length;
                    
                    if (warningsCount === 0) {
                        return await interaction.reply({
                            content: `‚úÖ ${user.tag} n√£o possui advert√™ncias para limpar.`,
                            flags: MessageFlags.Ephemeral
                        });
                    }

                    if (clearUserWarnings(interaction.guild.id, user.id)) {
                        await interaction.reply({
                            content: `‚úÖ ${warningsCount} advert√™ncia(s) removida(s) de ${user.tag}.`,
                            flags: MessageFlags.Ephemeral
                        });
                    } else {
                        await interaction.reply({
                            content: '‚ùå Erro ao limpar advert√™ncias.',
                            flags: MessageFlags.Ephemeral
                        });
                    }
                    break;
                }
            }
        } catch (error) {
            console.error('Erro no comando warn:', error);
            await interaction.reply({
                content: '‚ùå Ocorreu um erro ao executar este comando.',
                flags: MessageFlags.Ephemeral
            });
        }
    }
};